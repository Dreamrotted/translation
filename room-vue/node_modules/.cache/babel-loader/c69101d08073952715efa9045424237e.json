{"ast":null,"code":"import request from \"@/utils/request\";\nexport default {\n  data() {\n    return {\n      dataList: [],\n      current: 1,\n      pageSize: 10,\n      totalPage: 0,\n      dataListLoading: false,\n      query: {\n        roomNumber: '',\n        seatNumber: '',\n        status: '',\n        dateRange: null\n      }\n    };\n  },\n\n  methods: {\n    getDataList() {\n      this.dataListLoading = true;\n      const params = {\n        pageNum: this.current,\n        pageSize: this.pageSize,\n        studentNumber: JSON.parse(localStorage.getItem(\"user\")).studentNumber\n      }; // 添加查询条件\n\n      if (this.query.roomNumber) {\n        params.roomNumber = this.query.roomNumber;\n      }\n\n      if (this.query.seatNumber) {\n        params.seatNumber = this.query.seatNumber;\n      }\n\n      if (this.query.status) {\n        params.status = this.query.status;\n      }\n\n      if (this.query.dateRange && this.query.dateRange.length === 2) {\n        params.startDate = this.query.dateRange[0];\n        params.endDate = this.query.dateRange[1];\n      }\n\n      request.get('/reservation/page', {\n        params\n      }).then(resp => {\n        if (resp.code === 200) {\n          this.dataList = resp.data.list;\n          this.totalPage = resp.data.total;\n          console.log('预约记录数据:', this.dataList); // 调试日志\n        } else {\n          this.dataList = [];\n          this.$message.error(resp.message || '获取预约记录失败');\n        }\n\n        this.dataListLoading = false;\n      }).catch(err => {\n        console.error('获取预约记录错误:', err);\n        this.dataList = [];\n        this.dataListLoading = false;\n        this.$message.error('获取预约记录失败，请稍后重试');\n      });\n    },\n\n    resetSearch() {\n      this.query = {\n        roomNumber: '',\n        seatNumber: '',\n        status: '',\n        dateRange: null\n      };\n      this.current = 1;\n      this.getDataList();\n    },\n\n    sizeChangeHandle(val) {\n      this.pageSize = val;\n      this.current = 1;\n      this.getDataList();\n    },\n\n    currentChangeHandle(val) {\n      this.current = val;\n      this.getDataList();\n    },\n\n    // 判断是否可以签到\n    canCheckIn(row) {\n      const startTime = new Date(row.startTime);\n      const now = new Date(); // 预约开始后15分钟内可以签到\n\n      const diffMinutes = (now.getTime() - startTime.getTime()) / (1000 * 60);\n      return now >= startTime && diffMinutes <= 15;\n    },\n\n    // 判断是否可以取消\n    canCancel(row) {\n      const startTime = new Date(row.startTime);\n      const now = new Date();\n      const diffMinutes = (startTime.getTime() - now.getTime()) / (1000 * 60);\n      return diffMinutes >= 30;\n    },\n\n    // 取消预约\n    cancel(row) {\n      this.$confirm('确认取消预约, 是否继续?', '提示', {\n        confirmButtonText: '确定',\n        cancelButtonText: '取消',\n        type: 'warning'\n      }).then(() => {\n        request.post('/reservation/cancel', {\n          reservationId: row.id,\n          studentId: JSON.parse(localStorage.getItem(\"user\")).id\n        }).then(resp => {\n          if (resp.code === 200) {\n            this.$message.success('取消成功');\n            this.getDataList();\n          } else {\n            this.$message.error(resp.message || '取消失败');\n          }\n        }).catch(err => {\n          console.error('取消预约错误:', err);\n          this.$message.error('取消失败，请稍后重试');\n        });\n      }).catch(() => {});\n    },\n\n    // 签到\n    checkIn(row) {\n      this.$confirm('确认签到, 是否继续?', '提示', {\n        confirmButtonText: '确定',\n        cancelButtonText: '取消',\n        type: 'info'\n      }).then(() => {\n        request.post('/reservation/checkIn', {\n          reservationId: row.id,\n          studentId: JSON.parse(localStorage.getItem(\"user\")).id\n        }).then(resp => {\n          if (resp.code === 200) {\n            this.$message.success('签到成功');\n            this.getDataList();\n          } else {\n            this.$message.error(resp.message || '签到失败');\n          }\n        }).catch(err => {\n          console.error('签到错误:', err);\n          this.$message.error('签到失败，请稍后重试');\n        });\n      }).catch(() => {});\n    },\n\n    // 签退\n    checkOut(row) {\n      this.$confirm('确认签退, 是否继续?', '提示', {\n        confirmButtonText: '确定',\n        cancelButtonText: '取消',\n        type: 'info'\n      }).then(() => {\n        request.post('/reservation/checkOut', {\n          reservationId: row.id,\n          studentId: JSON.parse(localStorage.getItem(\"user\")).id\n        }).then(resp => {\n          if (resp.code === 200) {\n            this.$message.success('签退成功');\n            this.getDataList();\n          } else {\n            this.$message.error(resp.message || '签退失败');\n          }\n        }).catch(err => {\n          console.error('签退错误:', err);\n          this.$message.error('签退失败，请稍后重试');\n        });\n      }).catch(() => {});\n    }\n\n  },\n\n  created() {\n    this.getDataList();\n  }\n\n};","map":{"version":3,"mappings":"AA4HA;AAEA;EACAA;IACA;MACAC,YADA;MAEAC,UAFA;MAGAC,YAHA;MAIAC,YAJA;MAKAC,sBALA;MAMAC;QACAC,cADA;QAEAC,cAFA;QAGAC,UAHA;QAIAC;MAJA;IANA;EAaA,CAfA;;EAgBAC;IACAC;MACA;MACA;QACAC,qBADA;QAEAV,uBAFA;QAGAW;MAHA,EAFA,CAQA;;MACA;QACAC;MACA;;MACA;QACAA;MACA;;MACA;QACAA;MACA;;MACA;QACAA;QACAA;MACA;;MAEAC;QAAAD;MAAA;QACA;UACA;UACA;UACAE,sCAHA,CAGA;QACA,CAJA,MAIA;UACA;UACA;QACA;;QACA;MACA,CAVA,EAUAC,KAVA,CAUAC;QACAF;QACA;QACA;QACA;MACA,CAfA;IAgBA,CAxCA;;IAyCAG;MACA;QACAb,cADA;QAEAC,cAFA;QAGAC,UAHA;QAIAC;MAJA;MAMA;MACA;IACA,CAlDA;;IAmDAW;MACA;MACA;MACA;IACA,CAvDA;;IAwDAC;MACA;MACA;IACA,CA3DA;;IA4DA;IACAC;MACA;MACA,uBAFA,CAGA;;MACA;MACA;IACA,CAnEA;;IAoEA;IACAC;MACA;MACA;MACA;MACA;IACA,CA1EA;;IA2EA;IACAC;MACA;QACAC,uBADA;QAEAC,sBAFA;QAGAC;MAHA,GAIAC,IAJA,CAIA;QACAb;UACAc,qBADA;UAEAC;QAFA,GAGAF,IAHA,CAGAG;UACA;YACA;YACA;UACA,CAHA,MAGA;YACA;UACA;QACA,CAVA,EAUAd,KAVA,CAUAC;UACAF;UACA;QACA,CAbA;MAcA,CAnBA,EAmBAC,KAnBA,CAmBA,QAnBA;IAoBA,CAjGA;;IAkGA;IACAe;MACA;QACAP,uBADA;QAEAC,sBAFA;QAGAC;MAHA,GAIAC,IAJA,CAIA;QACAb;UACAc,qBADA;UAEAC;QAFA,GAGAF,IAHA,CAGAG;UACA;YACA;YACA;UACA,CAHA,MAGA;YACA;UACA;QACA,CAVA,EAUAd,KAVA,CAUAC;UACAF;UACA;QACA,CAbA;MAcA,CAnBA,EAmBAC,KAnBA,CAmBA,QAnBA;IAoBA,CAxHA;;IAyHA;IACAgB;MACA;QACAR,uBADA;QAEAC,sBAFA;QAGAC;MAHA,GAIAC,IAJA,CAIA;QACAb;UACAc,qBADA;UAEAC;QAFA,GAGAF,IAHA,CAGAG;UACA;YACA;YACA;UACA,CAHA,MAGA;YACA;UACA;QACA,CAVA,EAUAd,KAVA,CAUAC;UACAF;UACA;QACA,CAbA;MAcA,CAnBA,EAmBAC,KAnBA,CAmBA,QAnBA;IAoBA;;EA/IA,CAhBA;;EAiKAiB;IACA;EACA;;AAnKA","names":["data","dataList","current","pageSize","totalPage","dataListLoading","query","roomNumber","seatNumber","status","dateRange","methods","getDataList","pageNum","studentNumber","params","request","console","catch","err","resetSearch","sizeChangeHandle","currentChangeHandle","canCheckIn","canCancel","cancel","confirmButtonText","cancelButtonText","type","then","reservationId","studentId","resp","checkIn","checkOut","created"],"sourceRoot":"src/views/student","sources":["reservation.vue"],"sourcesContent":["<!--学生预约记录-->\r\n<template>\r\n  <div class=\"container\">\r\n    <!--条件查询-->\r\n    <div class=\"search-bar\">\r\n      <el-input v-model=\"query.roomNumber\" placeholder=\"自习室编号\" style=\"width: 150px;\"\r\n                @keyup.enter.native=\"getDataList\"></el-input>\r\n      <el-input v-model=\"query.seatNumber\" placeholder=\"座位编号\" style=\"width: 150px; margin-left: 10px;\"\r\n                @keyup.enter.native=\"getDataList\"></el-input>\r\n      <el-select v-model=\"query.status\" placeholder=\"预约状态\" style=\"width: 150px; margin-left: 10px;\" clearable>\r\n        <el-option label=\"已预约\" value=\"已预约\"></el-option>\r\n        <el-option label=\"已取消\" value=\"已取消\"></el-option>\r\n        <el-option label=\"已过期\" value=\"已过期\"></el-option>\r\n        <el-option label=\"已完成\" value=\"已完成\"></el-option>\r\n      </el-select>\r\n      <el-date-picker\r\n          v-model=\"query.dateRange\"\r\n          type=\"daterange\"\r\n          range-separator=\"至\"\r\n          start-placeholder=\"开始日期\"\r\n          end-placeholder=\"结束日期\"\r\n          value-format=\"yyyy-MM-dd\"\r\n          style=\"width: 240px; margin-left: 10px;\">\r\n      </el-date-picker>\r\n      <el-button type=\"primary\" icon=\"el-icon-search\" @click=\"getDataList\" style=\"margin-left: 10px\">搜索</el-button>\r\n      <el-button icon=\"el-icon-refresh\" @click=\"resetSearch\" style=\"margin-left: 10px\">重置</el-button>\r\n    </div>\r\n\r\n    <el-table :data=\"dataList\"\r\n              border\r\n              stripe\r\n              v-loading=\"dataListLoading\"\r\n              highlight-current-row\r\n              align-content: center>\r\n      <el-table-column type=\"index\" min-width=\"80\" header-align=\"center\" align=\"center\" label=\"序号\"></el-table-column>\r\n      <el-table-column prop=\"studyRooms.roomNumber\" header-align=\"center\" align=\"center\" min-width=\"120\" label=\"自习室编号\">\r\n      </el-table-column>\r\n      <el-table-column prop=\"studyRooms.location\" header-align=\"center\" align=\"center\" min-width=\"150\" label=\"位置\">\r\n      </el-table-column>\r\n      <el-table-column header-align=\"center\" align=\"center\" min-width=\"120\" label=\"座位编号\">\r\n        <template v-slot=\"scope\">\r\n          <el-tag type=\"primary\" v-if=\"scope.row.seat\">\r\n            {{ scope.row.seat.seatNumber }}\r\n          </el-tag>\r\n          <span v-else>--</span>\r\n        </template>\r\n      </el-table-column>\r\n      <el-table-column header-align=\"center\" align=\"center\" min-width=\"100\" label=\"座位类型\">\r\n        <template v-slot=\"scope\">\r\n          {{ scope.row.seat ? scope.row.seat.seatType : '--' }}\r\n        </template>\r\n      </el-table-column>\r\n      <el-table-column header-align=\"center\" align=\"center\" min-width=\"120\" label=\"签到时间\">\r\n        <template v-slot=\"scope\">\r\n          {{ scope.row.checkInTime || '--' }}\r\n        </template>\r\n      </el-table-column>\r\n      <el-table-column header-align=\"center\" align=\"center\" min-width=\"120\" label=\"签退时间\">\r\n        <template v-slot=\"scope\">\r\n          {{ scope.row.checkOutTime || '--' }}\r\n        </template>\r\n      </el-table-column>\r\n      <el-table-column prop=\"startTime\" header-align=\"center\" align=\"center\" min-width=\"150\" label=\"开始时间\">\r\n      </el-table-column>\r\n      <el-table-column prop=\"endTime\" header-align=\"center\" align=\"center\" min-width=\"150\" label=\"结束时间\">\r\n      </el-table-column>\r\n      <el-table-column prop=\"status\" header-align=\"center\" align=\"center\" min-width=\"100\" label=\"状态\">\r\n        <template v-slot=\"scope\">\r\n          <el-tag v-if=\"scope.row.status === '已预约'\" type=\"success\">已预约</el-tag>\r\n          <el-tag v-else-if=\"scope.row.status === '已取消'\" type=\"info\">已取消</el-tag>\r\n          <el-tag v-else-if=\"scope.row.status === '已过期'\" type=\"warning\">已过期</el-tag>\r\n          <el-tag v-else-if=\"scope.row.status === '已完成'\" type=\"primary\">已完成</el-tag>\r\n          <el-tag v-else type=\"info\">{{ scope.row.status }}</el-tag>\r\n        </template>\r\n      </el-table-column>\r\n      <el-table-column fixed=\"right\" header-align=\"center\" align=\"center\" width=\"250\" label=\"操作\">\r\n        <template v-slot=\"scope\">\r\n          <!-- 签到按钮 -->\r\n          <el-button \r\n            type=\"primary\" \r\n            size=\"small\" \r\n            @click=\"checkIn(scope.row)\" \r\n            v-if=\"scope.row.status === '已预约' && scope.row.isCheckedIn === 0 && canCheckIn(scope.row)\">\r\n            签到\r\n          </el-button>\r\n          <!-- 签退按钮 -->\r\n          <el-button \r\n            type=\"success\" \r\n            size=\"small\" \r\n            @click=\"checkOut(scope.row)\" \r\n            v-if=\"scope.row.status === '已预约' && scope.row.isCheckedIn === 1 && scope.row.isCheckedOut === 0\">\r\n            签退\r\n          </el-button>\r\n          <!-- 取消预约按钮 -->\r\n          <el-button \r\n            type=\"danger\" \r\n            size=\"small\" \r\n            @click=\"cancel(scope.row)\" \r\n            v-if=\"scope.row.status === '已预约' && scope.row.isCheckedIn === 0 && canCancel(scope.row)\">\r\n            取消预约\r\n          </el-button>\r\n          <!-- 无法取消提示 -->\r\n          <el-tooltip v-else-if=\"scope.row.status === '已预约' && scope.row.isCheckedIn === 0\" content=\"预约开始前30分钟内不能取消\" placement=\"top\">\r\n            <el-button type=\"info\" size=\"small\" disabled>无法取消</el-button>\r\n          </el-tooltip>\r\n          <span v-else>--</span>\r\n        </template>\r\n      </el-table-column>\r\n    </el-table>\r\n\r\n    <el-pagination\r\n        @size-change=\"sizeChangeHandle\"\r\n        @current-change=\"currentChangeHandle\"\r\n        :current-page=\"current\"\r\n        :page-sizes=\"[10, 20, 50, 100]\"\r\n        :page-size=\"pageSize\"\r\n        :total=\"totalPage\"\r\n        layout=\"total, sizes, prev, pager, next, jumper\">\r\n    </el-pagination>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\n\r\nimport request from \"@/utils/request\";\r\n\r\nexport default {\r\n  data() {\r\n    return {\r\n      dataList: [],\r\n      current: 1,\r\n      pageSize: 10,\r\n      totalPage: 0,\r\n      dataListLoading: false,\r\n      query: {\r\n        roomNumber: '',\r\n        seatNumber: '',\r\n        status: '',\r\n        dateRange: null\r\n      }\r\n    };\r\n  },\r\n  methods: {\r\n    getDataList() {\r\n      this.dataListLoading = true;\r\n      const params = {\r\n        pageNum: this.current,\r\n        pageSize: this.pageSize,\r\n        studentNumber: JSON.parse(localStorage.getItem(\"user\")).studentNumber,\r\n      };\r\n      \r\n      // 添加查询条件\r\n      if (this.query.roomNumber) {\r\n        params.roomNumber = this.query.roomNumber;\r\n      }\r\n      if (this.query.seatNumber) {\r\n        params.seatNumber = this.query.seatNumber;\r\n      }\r\n      if (this.query.status) {\r\n        params.status = this.query.status;\r\n      }\r\n      if (this.query.dateRange && this.query.dateRange.length === 2) {\r\n        params.startDate = this.query.dateRange[0];\r\n        params.endDate = this.query.dateRange[1];\r\n      }\r\n      \r\n      request.get('/reservation/page', { params }).then((resp) => {\r\n        if (resp.code === 200) {\r\n          this.dataList = resp.data.list;\r\n          this.totalPage = resp.data.total;\r\n          console.log('预约记录数据:', this.dataList); // 调试日志\r\n        } else {\r\n          this.dataList = [];\r\n          this.$message.error(resp.message || '获取预约记录失败');\r\n        }\r\n        this.dataListLoading = false;\r\n      }).catch(err => {\r\n        console.error('获取预约记录错误:', err);\r\n        this.dataList = [];\r\n        this.dataListLoading = false;\r\n        this.$message.error('获取预约记录失败，请稍后重试');\r\n      });\r\n    },\r\n    resetSearch() {\r\n      this.query = {\r\n        roomNumber: '',\r\n        seatNumber: '',\r\n        status: '',\r\n        dateRange: null\r\n      };\r\n      this.current = 1;\r\n      this.getDataList();\r\n    },\r\n    sizeChangeHandle(val) {\r\n      this.pageSize = val;\r\n      this.current = 1;\r\n      this.getDataList();\r\n    },\r\n    currentChangeHandle(val) {\r\n      this.current = val;\r\n      this.getDataList();\r\n    },\r\n    // 判断是否可以签到\r\n    canCheckIn(row) {\r\n      const startTime = new Date(row.startTime);\r\n      const now = new Date();\r\n      // 预约开始后15分钟内可以签到\r\n      const diffMinutes = (now.getTime() - startTime.getTime()) / (1000 * 60);\r\n      return now >= startTime && diffMinutes <= 15;\r\n    },\r\n    // 判断是否可以取消\r\n    canCancel(row) {\r\n      const startTime = new Date(row.startTime);\r\n      const now = new Date();\r\n      const diffMinutes = (startTime.getTime() - now.getTime()) / (1000 * 60);\r\n      return diffMinutes >= 30;\r\n    },\r\n    // 取消预约\r\n    cancel(row) {\r\n      this.$confirm('确认取消预约, 是否继续?', '提示', {\r\n        confirmButtonText: '确定',\r\n        cancelButtonText: '取消',\r\n        type: 'warning'\r\n      }).then(() => {\r\n        request.post('/reservation/cancel', {\r\n          reservationId: row.id,\r\n          studentId: JSON.parse(localStorage.getItem(\"user\")).id\r\n        }).then((resp) => {\r\n          if (resp.code === 200) {\r\n            this.$message.success('取消成功');\r\n            this.getDataList();\r\n          } else {\r\n            this.$message.error(resp.message || '取消失败');\r\n          }\r\n        }).catch(err => {\r\n          console.error('取消预约错误:', err);\r\n          this.$message.error('取消失败，请稍后重试');\r\n        });\r\n      }).catch(() => {});\r\n    },\r\n    // 签到\r\n    checkIn(row) {\r\n      this.$confirm('确认签到, 是否继续?', '提示', {\r\n        confirmButtonText: '确定',\r\n        cancelButtonText: '取消',\r\n        type: 'info'\r\n      }).then(() => {\r\n        request.post('/reservation/checkIn', {\r\n          reservationId: row.id,\r\n          studentId: JSON.parse(localStorage.getItem(\"user\")).id\r\n        }).then((resp) => {\r\n          if (resp.code === 200) {\r\n            this.$message.success('签到成功');\r\n            this.getDataList();\r\n          } else {\r\n            this.$message.error(resp.message || '签到失败');\r\n          }\r\n        }).catch(err => {\r\n          console.error('签到错误:', err);\r\n          this.$message.error('签到失败，请稍后重试');\r\n        });\r\n      }).catch(() => {});\r\n    },\r\n    // 签退\r\n    checkOut(row) {\r\n      this.$confirm('确认签退, 是否继续?', '提示', {\r\n        confirmButtonText: '确定',\r\n        cancelButtonText: '取消',\r\n        type: 'info'\r\n      }).then(() => {\r\n        request.post('/reservation/checkOut', {\r\n          reservationId: row.id,\r\n          studentId: JSON.parse(localStorage.getItem(\"user\")).id\r\n        }).then((resp) => {\r\n          if (resp.code === 200) {\r\n            this.$message.success('签退成功');\r\n            this.getDataList();\r\n          } else {\r\n            this.$message.error(resp.message || '签退失败');\r\n          }\r\n        }).catch(err => {\r\n          console.error('签退错误:', err);\r\n          this.$message.error('签退失败，请稍后重试');\r\n        });\r\n      }).catch(() => {});\r\n    }\r\n  },\r\n  created() {\r\n    this.getDataList();\r\n  },\r\n}\r\n</script>\r\n\r\n<style scoped>\r\n.container {\r\n  padding: 20px;\r\n}\r\n\r\n.search-bar {\r\n  margin-bottom: 20px;\r\n}\r\n</style>"]},"metadata":{},"sourceType":"module"}